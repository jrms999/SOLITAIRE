Ext.ns("Solitaire");Solitaire.Game=function(){this.createSuitStacks();this.createStacks();this.createDeckAndDealer();if(!this.win){this.win=new Solitaire.MainWindow({deck:this.deck,dealer:this.dealer,suitStacks:this.suitStacks,stacks:this.stacks,game:this,listeners:{newgame:{scope:this,fn:function(){if(this.inProgress){Ext.Msg.confirm("Game in progress","Are you sure?  You'll lose your current game",function(A){if(A=="yes"){window.location=window.location}})}else{window.location=window.location}}}}})}this.newGame()};Solitaire.Game.prototype={stacks:[],suitStacks:[],inProgress:false,numberOfStacks:7,startTime:new Date(),timeTaken:function(){this.startTime=this.startTime||new Date();return Math.round((new Date()-this.startTime)/1000)},newGame:function(){for(var A=0;A<this.suitStacks.length;A++){var B=this.suitStacks[A];if(B.items){B.items.each(function(C){B.remove(C);C.destroy()});B.doLayout()}}for(var A=0;A<this.stacks.length;A++){var B=this.stacks[A];if(B.items){B.items.each(function(C){B.remove(C);C.destroy()});B.doLayout()}}this.pack=new Solitaire.Pack();this.initialiseStacks();this.deck.claimUndealtCards(this.pack);this.pack.on("movecard",this.updateGameState,this);this.pack.on("carddblclick",this.autoMoveCard,this);this.startTime=new Date()},getScore:function(){var B=0;for(var A=0;A<this.suitStacks.length;A++){if(this.suitStacks[A].items){B+=(this.suitStacks[A].items.length*10)}}B-=(Math.floor(this.timeTaken()/10));return B},inWinState:function(){for(var A=0;A<this.suitStacks.length;A++){if(!this.suitStacks[A].isComplete()){return false}}return true},updateGameState:function(){if(this.inWinState()){if(this.inProgress){this.inProgress=false;this.displayWinMessage()}}else{this.inProgress=true}},autoMoveCard:function(A){for(var B=0;B<this.suitStacks.length;B++){var C=this.suitStacks[B];if(C.dropAllowed(A)){A.moveTo(C);return true}}return false},displayWinMessage:function(){Ext.Msg.alert("Winnerman!","You've won, well done.  Seriously, you're awesome, just amazing.")},createDeckAndDealer:function(){this.dealer=new Solitaire.Dealer();this.deck=new Solitaire.Deck({pack:this.pack,dealer:this.dealer})},initialiseStacks:function(){for(var D=0;D<this.stacks.length;D++){var A=this.stacks[D];for(var C=0;C<=D;C++){var B=this.pack.getTopCard();B.revealed=(D==C);B.moveTo(A)}}},createStacks:function(){for(var B=0;B<this.numberOfStacks;B++){var A=new Solitaire.Stack({listeners:{carddropped:{fn:function(C,D){this.pack.moveCard(D,C)},scope:this}}});this.stacks.push(A)}return this.stacks},createSuitStacks:function(){var B=Solitaire.Card.prototype.suits.length;this.suitStacks=this.suitStacks||[];for(var A=0;A<B;A++){this.suitStacks.push(new Solitaire.SuitStack({listeners:{carddropped:{fn:function(C,D){this.pack.moveCard(D,C)},scope:this}}}))}return this.suitStacks},launch:function(){this.win.show()}};Solitaire.MainWindow=function(A){var A=A||{};this.topPanel=new Ext.Panel({layout:"column",region:"north",height:130,defaults:{border:false,layout:"column"},items:[{columnWidth:(3/7),items:[A.dealer,A.deck,{html:""}],defaults:{columnWidth:(1/3),border:false}},{columnWidth:(4/7),items:A.suitStacks,defaults:{columnWidth:(1/4)}}]});this.decksPanel=new Ext.Panel({layout:"column",region:"center",items:A.stacks,autoScroll:true,defaults:{columnWidth:(1/A.stacks.length)}});this.score=new Ext.Toolbar.TextItem("0");this.time=new Ext.Toolbar.TextItem("0");this.leftInDeck=new Ext.Toolbar.TextItem("24");this.bbar=new Ext.StatusBar({statusAlign:"right",items:["Left in deck: ",this.leftInDeck,"->","Score:",this.score,"-","Time:",this.time]});Ext.applyIf(A,{title:"Solitaire",height:680,width:900,layout:"border",cls:"x-solitaire-window",constrain:true,closable:false,tbar:[{text:"New Game",scope:this,handler:function(){this.fireEvent("newgame",this)}},"-",{text:"Options",menu:[{text:"Card background",menu:{defaults:{checked:false,group:"background",scope:this,checkHandler:function(C,B){if(B){this.fireEvent("changeCardBackground",C.text)}}},items:[{text:"Crown"},{text:"Cross",checked:true},{text:"Circle"},{text:"Woman"},{text:"Roses"},{text:"Checkered"},{text:"Squares"}]}}]},"-",{text:"About",menu:{items:[{text:"View Source",handler:function(){window.open("http://github.com/edspencer/extjs-solitaire/tree/master")}},{text:"Download Source",handler:function(){window.open("http://github.com/edspencer/extjs-solitaire/zipball/master")}},{text:"View blog post",handler:function(){window.open("http://edspencer.net/2009/01/extjs-solitaire.html")}},{text:"Scoring",scope:this,handler:this.showScoringHelp}]}}],bbar:this.bbar,defaults:{border:false},items:[this.topPanel,this.decksPanel]});Solitaire.MainWindow.superclass.constructor.call(this,A);this.addEvents("newgame","changeCardBackground");this.on("render",function(){this.el.alignTo(Ext.getBody(),"c")},this);this.on("changeCardBackground",this.setCardBackground,this);Ext.TaskMgr.start({run:function(){Ext.fly(this.leftInDeck.getEl()).update(this.game.deck.items.length);if(!this.game.inWinState()){Ext.fly(this.score.getEl()).update(this.game.getScore());Ext.fly(this.time.getEl()).update(this.game.timeTaken())}},interval:250,scope:this})};Ext.extend(Solitaire.MainWindow,Ext.Window,{scoreHelpWindow:null,showScoringHelp:function(){if(!this.scoreHelpWindow){this.scoreHelpWindow=new Ext.Window({constrain:true,title:"Scoring",cls:"solitaire-info",width:400,height:200,layout:"fit",items:[{html:"<h1>Scoring</h1><p>You get 10 points for every card you stack on the top card stacks.</p><p>You lose a point for every 10 seconds that pass without winning.</p>"}],closeAction:"hide"})}this.scoreHelpWindow.show()},setCardBackground:function(A){var C=0;var B=Solitaire.Card.prototype.cardWidth;switch(A){case"Cross":C=1;break;case"Circle":C=2;break;case"Woman":C=3;break;case"Roses":C=4;break;case"Checkered":C=5;break;case"Squares":C=6;break}Ext.util.CSS.updateRule(".x-solitaire-card-hidden","background-position","-"+B*C+"px 100px")}});Solitaire.Deck=function(A){var A=A||{};Solitaire.Deck.superclass.constructor.call(this,A);this.claimUndealtCards(A.pack);this.dealer=A.dealer;this.dealer.on("click",this.cycleCards,this);this.on("afterlayout",this.applyClasses,this)};Ext.extend(Solitaire.Deck,Ext.Container,{claimUndealtCards:function(A){this.pack=A||this.pack;if(this.pack){while(c=this.pack.getTopCard()){this.pack.moveCard(c,this)}}},numberToDeal:1,onRender:function(B,A){this.el=Ext.get(B).createChild({cls:"x-solitaire-deck-wrapper",children:[{cls:"x-solitaire-deck",style:"background: url(images/cards.gif) no-repeat bottom right;"}]});this.deckHolder=this.el.child(".x-solitaire-deck");Solitaire.Deck.superclass.onRender.apply(this,arguments)},getLayoutTarget:function(A){return this.deckHolder},applyClasses:function(){this.items.each(function(A){if(A==this.items.items[this.items.length-1]){A.addClass("x-solitaire-card-top");A.removeClass("x-solitaire-card-under");A.reveal()}else{A.addClass("x-solitaire-card-under");A.removeClass("x-solitaire-card-top")}A.initializeDragSource()},this)},cycleCards:function(){var A=this.items.first();if(A){this.remove(A);this.add(A);this.doLayout()}}});Solitaire.Dealer=Ext.extend(Ext.Container,{onRender:function(A){this.el=A.createChild({cls:"x-solitaire-dealer-wrapper",children:[{cls:"x-solitaire-dealer x-solitaire-card-hidden",style:"background-image: url(images/cards.gif);"}]});this.dealHolder=this.el.child(".x-solitaire-deal");this.relayEvents(this.el,["click"]);Solitaire.Dealer.superclass.onRender.apply(this,arguments)},getLayoutTarget:function(){return this.dealHolder}});Ext.reg("solitaire-deal",Solitaire.Dealer);Solitaire.Card=function(A){var A=A||{};Ext.apply(this,{revealed:false,location:null},A);Solitaire.Card.superclass.constructor.call(this,{});this.addEvents("dblclick");this.on("render",this.initializeDragSource,this)};Ext.extend(Solitaire.Card,Ext.Component,{cardHeight:100,cardWidth:72,suits:["Hearts","Diamonds","Clubs","Spades"],numbers:["Ace","2","3","4","5","6","7","8","9","10","Jack","Queen","King"],imageUrl:"images/cards.gif",moveTo:function(B,A){if(!this.pack){return false}return this.pack.moveCard(this,B,A)},getColour:function(){if(this.suit=="Hearts"||this.suit=="Diamonds"){return"red"}if(this.suit=="Clubs"||this.suit=="Spades"){return"black"}throw new Error("Could not determine the colour of the "+this.suit+" suit.")},onRender:function(C,A){var B=this.revealed?"x-solitaire-card-revealed":"x-solitaire-card-hidden";this.el=C.createChild({tag:"div",cls:"x-solitaire-card "+B,style:this.imageStyle(this)})},imageStyle:function(){if(this.revealed){var B=this.cardHeight*-this.suits.indexOf(this.suit);var A=this.cardWidth*-this.numbers.indexOf(this.number);return String.format("background-image: url({0}); background-position: {1}px {2}px",this.imageUrl,A,B)}else{return String.format("background-image: url({0});",this.imageUrl)}},reveal:function(){this.revealed=true;this.el.applyStyles(this.imageStyle())},getBestMatch:function(C){try{var E=null;var B=C.length;if(B==1){E=C[0]}else{for(var D=0;D<B;++D){var A=C[D];if(false&&A.cursorIsOver){E=A;break}else{if(!E||E.overlap.getArea()<A.overlap.getArea()){E=A}}}}return E}catch(F){}},initializeDragSource:function(){this.el.on("dblclick",function(){this.fireEvent("dblclick",this)},this);if(this.dragSource){this.dragSource.destroy();delete this.dragSource}if(!this.revealed){return false}var A=this;this.dragSource=new Ext.dd.DragSource(this.getEl(),{getDragData:function(){return{card:A}},onDragOver:function(B,C){this.cachedTarget=A.getBestMatch(C);Ext.dd.DragSource.prototype.onDragOver.apply(this,arguments)},autoOffset:function(B,F){var C=A.getEl().getXY();var E=B-C[0]+22;var D=F-C[1];this.setDelta(E,D)},onInitDrag:function(C,G){var B=A.location;if(B&&B.isXType("solitaire-stack")&&A!=B.getTopCard()){var E=B.getCardsAbove(A);var F=Ext.DomHelper.append(Ext.getBody(),{id:Ext.id()},false);for(var D=0;D<E.length;D++){F.appendChild(E[D].el.dom.cloneNode(true))}this.proxy.update(F)}else{var F=this.el.dom.cloneNode(true);F.id=Ext.id();this.proxy.update(F)}this.onStartDrag(C,G);return true},onDragEnter:function(D,E){var C=A.getBestMatch(E);if(this.beforeDragEnter(C,D,E)!==false){if(C.isNotifyTarget){var B=C.notifyEnter(this,D,this.dragData);this.proxy.setStatus(B)}else{this.proxy.setStatus(this.dropAllowed)}if(this.afterDragEnter){this.afterDragEnter(C,D,E)}}},onDragOut:function(B,C){this.cachedTarget=A.getBestMatch(C);Ext.dd.DragSource.prototype.onDragOut.apply(this,arguments)},onDragDrop:function(B,C){this.cachedTarget=A.getBestMatch(C);Ext.dd.DragSource.prototype.onDragDrop.apply(this,arguments)}})}});Ext.reg("solitaire-card",Solitaire.Card);Solitaire.Pack=function(E){var E=E||{};var G=[];var B=Solitaire.Card.prototype.suits;var A=Solitaire.Card.prototype.numbers;Solitaire.Pack.superclass.constructor.call(this,E);this.addEvents("beforemovecard","movecard","carddblclick");for(var F=0;F<B.length;F++){for(var D=0;D<A.length;D++){var C=new Solitaire.Card({suit:B[F],number:A[D],pack:this,listeners:{dblclick:{scope:this,fn:function(H){this.fireEvent("carddblclick",H,this)}}}});G.push(C)}}this.getRevealed=function(){};this.getUnrevealed=function(){};this.moveCard=function(I,H,O){var J=I.location;if(this.fireEvent("beforemovecard",this,I,H,J)){var N=[I];if(J){if(J.isXType("solitaire-stack",true)){var P=J.items.indexOf(I);var K=J.items.length;for(var L=P+1;L<K;L++){N.push(J.items.get(L))}}for(var M=0;M<N.length;M++){J.remove(N[M])}J.doLayout()}for(var M=0;M<N.length;M++){if(typeof O=="undefined"){H.add(N[M])}else{H.insert(O,N[M])}N[M].location=H;this.fireEvent("movecard",this,N[M],H,J)}H.doLayout();var Q=this;for(var M=0;M<N.length;M++){N[M].on("dblclick",function(){Q.fireEvent("carddblclick",this,Q)})}return true}};this.getTopCard=function(){return G.shift()};this.shuffle=function(M){var M=M||1;for(var I=M-1;I>=0;I--){var L=G.length;while(--L){var K=Math.floor(Math.random()*(L+1));var J=G[L];var H=G[K];G[L]=H;G[K]=J}}};this.shuffle()};Ext.extend(Solitaire.Pack,Ext.util.Observable);Solitaire.Stack=function(A){var A=A||{};this.addCard=function(B){this.add(B)};this.removeCard=function(){return cards.pop()};Solitaire.Stack.superclass.constructor.call(this,A);this.addEvents("carddropped");this.on("render",this.initializeDropTarget,this);this.on("afterlayout",this.applyClasses,this)};Ext.extend(Solitaire.Stack,Ext.Container,{dropAllowed:function(C){var E=Solitaire.Card.prototype.numbers;var B=this.getTopCard();if(B){var A=E.indexOf(C.number)==(E.indexOf(B.number)-1);var D=B.getColour()!=C.getColour();return A&&D}else{return C.number==E[E.length-1]}},getTopCard:function(){if(!this.items||this.items.length==0){return null}return this.items.items[this.items.items.length-1]},getCardsAbove:function(C){var A=[];var B=this.items.items;var E=false;for(var D=0;D<B.length;D++){var F=B[D];if(F==C){E=true}if(E){A.push(F)}}return A},applyClasses:function(){this.items.each(function(A){if(A==this.items.items[this.items.length-1]){A.addClass("x-solitaire-card-top");A.removeClass("x-solitaire-card-under");A.reveal()}else{A.addClass("x-solitaire-card-under");A.removeClass("x-solitaire-card-top")}A.initializeDragSource()},this)},onRender:function(B,A){this.el=B.createChild({cls:"x-solitaire-stack-wrapper",children:[{cls:"x-solitaire-stack",style:"background: url(images/cards.gif) no-repeat bottom right;"}]});this.stackHolder=this.el.child(".x-solitaire-stack");Solitaire.Stack.superclass.onRender.apply(this,arguments)},getLayoutTarget:function(){return this.stackHolder},initializeDropTarget:function(){var A=this;this.dropTarget=new Ext.dd.DropTarget(this.getEl(),{notifyOver:function(C,D,B){if(A.dropAllowed(B.card)){return Ext.dd.DropTarget.prototype.dropAllowed}else{return Ext.dd.DropTarget.prototype.dropNotAllowed}},notifyDrop:function(C,D,B){if(A.dropAllowed(B.card)){return A.fireEvent("carddropped",A,B.card)}else{return false}}})}});Ext.reg("solitaire-stack",Solitaire.Stack);Solitaire.SuitStack=function(A){var A=A||{};Solitaire.SuitStack.superclass.constructor.call(this,A)};Ext.extend(Solitaire.SuitStack,Solitaire.Stack,{dropAllowed:function(C){var E=Solitaire.Card.prototype.numbers;var B=this.getTopCard();if(!B){if(E.indexOf(C.number)==0){return true}else{return false}}var D=(B.suit==C.suit);var A=E.indexOf(C.number)==(E.indexOf(B.number)+1);return D&&A},isComplete:function(){if(!this.items){return false}var B=Solitaire.Card.prototype.numbers;for(var A=0;A<B.length;A++){if(!this.items.items[A]||this.items.items[A].number!=B[A]){return false}}return true},onRender:function(B,A){this.el=B.createChild({cls:"x-solitaire-stack-wrapper",children:[{cls:"x-solitaire-suit-stack x-solitaire-stack",style:"background: url(images/cards.gif) no-repeat bottom right;"}]});this.stackHolder=this.el.child(".x-solitaire-suit-stack")}});